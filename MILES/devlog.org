#+TITLE: MILES development log
#+AUTHOR: D. HU
#+TODO: TODO(t) WAIT(w) | DONE(d)
#+TODO: | CNCL(c@/!)
#+TODO: REPORT(r!) BUG(b!) KNOWNCAUSE(k!) | FIXED(f!)
#+STARTUP: logdone

Version: v1 (202010??)
* DONE Re-tested [3/3]
** DONE fitChi2syn
CLOSED: [2020-06-03 Wed 23:11]
- Note taken on [2020-10-05 Mon 17:53] \\
  After converting some param to logarithmic, the calculation takes a bit more time, but not obvious (according to Fred's test)
** DONE read
CLOSED: [2020-10-23 Fri 10:56]
** FIXED profiles
CLOSED: [2020-04-25 Sat 19:27]
- Note taken on [2020-05-20 Wed 23:39] \\
  Corrected the integration in normalization tests. X grid should not be too wide or the the integration of undersampled profiles will not be 1
- State "FIXED"      from "DONE"       [2020-05-20 Wed 23:39]
** DONE compile
CLOSED: [2020-04-24 Fri 15:00]
* TODO tests [4/6]
** TODO fitHB
** DONE gibbs
CLOSED: [2020-09-28 Mon 15:06]
- [X] Vary 1 parameter a time to check the function ~specModel_gen~
- [X] Print parcurr(ipar) in the ~big_loop~ to check the parvec
- [X] Fix all but one parameter to check 
- [X] Redo above for the modified function with logarithmic param
- [X] plot the dist. for each param
** FIXED fitHBsyn
CLOSED: [2020-10-02 Fri 10:20]
- State "FIXED"      from "REPORT"     [2020-10-02 Fri 10:17]
- Note taken on [2020-09-24 Thu 17:39] \\
  Bad fit, probably due to the problem of ~specModel_gen~ \rarr add ~test_gibbs~
- State "REPORT"     from "DONE"       [2020-09-24 Thu 17:39]
** KNOWNCAUSE fitChi2
- Note taken on [2020-06-18 Thu 16:50] \\
  - [ ] Very slow, should add timers; 
  - [ ] Should be able to block and retake at a certain pixel; 
  - [ ] Discontinuity at 20 microns; 
  - [ ] ALL(mask(x,y,:)) or ANY(mask(x,y,:)) ? should allow lacking of isolated wvl (diff from the case of lacking the whole module); 
  - [ ] Diagonal covar matrix used (for now); 
  - [ ] Add calib error
  - [ ] Check if there is at least one wvl available in center \pm width/2 region for every line/band
  - [ ] Automatize param init ~initparam~
  - [X] Save all param (incl. fixed ones) in h5 file
- State "KNOWNCAUSE" from "TODO"       [2020-06-18 Thu 16:50]
** CNCL modifBB
CLOSED: [2020-06-10 Wed 12:06]
- State "CNCL"       from "KNOWNCAUSE" [2020-06-10 Wed 12:06] \\
  Transfer to complete fit test of M83 (~test_fitChi2~)
- Note taken on [2020-05-11 Mon 14:32] \\
  Test chi2min with observation (M83), 3D FITS data imported via Python UI (fits2h5)
- State "KNOWNCAUSE" from "DONE"       [2020-05-11 Mon 14:32]
* TODO MILES [60%]
:PROPERTIES:
:COOKIE_DATA: recursive
:END:
** DONE datable [3/3]
*** TYPE, PUBLIC
**** DONE ~instr_res~
CLOSED: [2020-05-11 Mon 13:31]
- res
**** DONE ~lines_IN~
CLOSED: [2020-05-11 Mon 13:57]
- LIN
**** DONE ~bands_IN~
CLOSED: [2020-05-11 Mon 13:57]
- BIN
** TODO auxil [81%]
*** TYPE, PUBLIC
**** DONE ~par_type~
CLOSED: [2020-05-11 Mon 10:52]
**** DONE ~parinfo_type~
CLOSED: [2020-06-09 Tue 18:51]
**** DONE ~indpar_type~
CLOSED: [2020-09-23 Wed 10:58]
**** DONE ~Qabs_type~
CLOSED: [2020-05-11 Mon 11:47]
- Note taken on [2020-10-01 Thu 15:16] \\
  Replace coeffMBB by kappa; remove Qova
- Note taken on [2020-09-23 Wed 10:54] \\
  Add coeffMBB (simplify calculation)
*** SUBROUTINE
**** TODO ~initparam~ : Automatic initialization of model parameters
**** DONE ~read_master~ : Read the input master file for the Chi2/HB run
CLOSED: [2020-10-23 Fri 10:13]
**** DONE ~set_indpar~ : Fill the INDPAR_TYPE structure, from a ~PARINFO_TYPE~ structure
CLOSED: [2020-09-23 Wed 10:58]
**** CNCL ~make_Qabs~ : Read optical properties
CLOSED: [2020-05-11 Mon 11:47]
- State "CNCL"       from "DONE"       [2020-09-23 Wed 10:57] \\
  Merged to ~read_master~
**** CNCL ~make_par~ : Create the parameter structure (obsolete)
CLOSED: [2020-06-09 Tue 09:53]
- State "CNCL"       from "FIXED"      [2020-09-04 Fri 10:26] \\
  Update to ~read_master~
- State "FIXED"      from "KNOWNCAUSE" [2020-06-10 Wed 09:53]
- Note taken on [2020-06-09 Tue 09:52] \\
  Add Npar and parinfo as output option; par turns to be optional
- State "KNOWNCAUSE" from "DONE"       [2020-06-09 Tue 09:51]
**** CNCL ~chi2_INIT~ : Initialization of parameters for Chi2 method
CLOSED: [2020-05-25 Mon 18:11]
- State "CNCL"       from "DONE"       [2020-06-02 Tue 10:23] \\
  Removed. Parameters stored in a separate module/file
*** FUNCTION
**** DONE ~degradeRes~ : Automatize the degradation of the spectral resolution
CLOSED: [2020-05-11 Mon 13:40]
**** Analytical functions of the individual features
***** KNOWNCAUSE ~modifBB~ : Dust contimuum (N BB)
- Note taken on [2020-09-30 Wed 18:49] \\
  lnMcont (mass of contimuum) should be ln(M/d^2) (lnMovd2) which is a mixing param in the sense of physics. The modified blackbody (MBB) here represents an average emission of the small grains of different size which are in stochastic state instead of thermal equilibrium. Indeed, if we suppose they each (in terms of size) are blackbody in a certain time scale (during which the temperature is constant T \prop h\nu), then the MBB we use here is the average effect in time. On the other hand, the mass Mcont as well as the distance d is not interesting unless we have indepandent observations to mesure them. (The same case for radiation field G_0 if we want to add stochastic heating model to include the time-dependant effect mentionned above.) For now we just leave ln(M/d^2) in our model as what Fred did in his Chi2 fitting code (on IDL).
- State "KNOWNCAUSE" from "DONE"       [2020-10-01 Thu 09:49]
- Note taken on [2020-09-23 Wed 10:53] \\
  Add generic interface for HB method
***** FIXED ~gaussLine~ : Atomic & molecular unresolved lines (Gauss profile)
CLOSED: [2020-05-20 Wed 23:36]
- Note taken on [2020-09-23 Wed 10:53] \\
  Add generic interface for HB method
- State "FIXED"      from "KNOWNCAUSE" [2020-05-20 Wed 23:36]
- Note taken on [2020-05-12 Tue 10:51] \\
  ~gaussLine_w~ was added to make wave-in-nu-out possible (which is the idea here), while it rose a confusion when doing normalization test. 
  Finally, the merger of this option lead to a LOGICAL "w2nu", .TRUE. when input is wavelength, because the profiles will be used to fit the obs curves in function of nu whose intensities Fnu are in W/m2/Hz (Jy). 
  Idem. for lorentzBand & extCurve
- State "KNOWNCAUSE" from "DONE"       [2020-05-12 Tue 10:51]
***** FIXED ~lorentzBand~ : Resolved aromatic bands (Asymmetric Lorentz profile)
CLOSED: [2020-05-20 Wed 23:36]
- Note taken on [2020-09-23 Wed 10:53] \\
  Add generic interface for HB method
- State "FIXED"      from "KNOWNCAUSE" [2020-05-20 Wed 23:36]
- State "KNOWNCAUSE" from "DONE"       [2020-05-12 Tue 10:57]
***** FIXED ~extCurve~
CLOSED: [2020-05-20 Wed 23:36]
- State "FIXED"      from "KNOWNCAUSE" [2020-05-20 Wed 23:36]
- State "KNOWNCAUSE" from "TODO"       [2020-05-12 Tue 10:57]
**** KNOWNCAUSE ~specModel~ : Total model function for Chi2/HB calling
- Note taken on [2020-10-01 Thu 15:17] \\
  Function & unit check: remove a extra pi in cont; lnMcont \rarr lnMovd2; lnTcont \rarr lnT; remove L_sun & pc in lnFstar unit
- Note taken on [2020-09-29 Tue 10:55] \\
  Logarithmic parameters (Mcont, Tcont, Iline, Iband, Av, Fstar)
- Note taken on [2020-09-22 Tue 16:00] \\
  1. Do NOT include ~CALL make_Qabs~ in the model, which will can repeat exponential times (e.g. reading procedure) in Bayesian/Mont-Carlo processes
  2. ~specModel_nD~
- Note taken on [2020-09-02 Wed 10:58] \\
  1. Adaptation for Bayesian method: add generic interface
  2. massBB \rarr Mcont, tempBB \rarr Tcont
- State "KNOWNCAUSE" from "FIXED"      [2020-09-02 Wed 10:58]
- State "FIXED"      from "REPORT"     [2020-06-17 Wed 01:56]
- Note taken on [2020-06-16 Tue 19:36] \\
  [via Fred]
  1. Do not read extcurve file everytime -> call it only once at the beginning
  2. Do not do interpolation in func modifBB -> interpolate Qabs once and for all (add optional input "waveall" in ~make_Qabs~)
- State "REPORT"     from "FIXED"      [2020-06-17 Wed 01:52]
- State "FIXED"      from "KNOWNCAUSE" [2020-06-16 Tue 15:22]
- Note taken on [2020-06-13 Sat 23:12] \\
  Create interface for 3D, 2D, etc. models
- State "KNOWNCAUSE" from "FIXED"      [2020-06-13 Sat 23:12]
- State "FIXED"      from "KNOWNCAUSE" [2020-06-09 Tue 10:26]
- Note taken on [2020-06-09 Tue 10:25] \\
  Add Npar and parinfo as output option
- State "KNOWNCAUSE" from "FIXED"      [2020-06-09 Tue 10:25]
- State "FIXED"      from "BUG"        [2020-06-03 Wed 17:20]
- Note taken on [2020-06-03 Wed 17:19] \\
  optional output should not be allocated out of IF (PRESENT) loop
- State "BUG"        from "FIXED"      [2020-06-03 Wed 17:19]
- State "FIXED"      from "KNOWNCAUSE" [2020-05-29 Fri 15:15]
- Note taken on [2020-05-26 Tue 16:41] \\
  Replace massStar by Fstar (total surface brightness of star), with BB normalized by Stefan-Boltzmann constant.
- State "KNOWNCAUSE" from "DONE"       [2020-05-26 Tue 16:41]
** DONE Init [100%]
*** DONE input spectrum (fits2h5.py)
CLOSED: [2020-05-11 Mon 15:21]
*** DONE modeled spectrum
CLOSED: [2020-06-09 Tue 18:51]
** TODO Chi2 [40%]
*** DONE test chi2min with synthetic spectrum
CLOSED: [2020-06-04 Thu 11:27]
*** DONE test chi2min with M83 (input 3D data)
CLOSED: [2020-06-18 Thu 16:50]
*** TODO Python UI for the inputs
*** TODO add Monte Carlo estimation for Chi2 convergence (in func ~initparam~)
*** TODO seperate spectra from diff modules and add calib error param
** TODO Bayesian [25%]
*** DONE build structure according to ~fitSED_HB~ code
CLOSED: [2020-09-03 Thu 17:30]
*** TODO test homogeneous prior dist. with synthetic spectrum
*** TODO automatize ~read_master~ and ~initparam~
*** TODO test with M83 spectra (init param via Chi2 results)
** TODO Hierarchical Bayesian [0%]
*** TODO add hyper param
*** TODO test HB with synthetic spectrum
* TODO PyUI [80%]
:PROPERTIES:
:COOKIE_DATA: recursive
:END:
** DONE ~input_master~
CLOSED: [2020-10-22 Thu 13:58]
** DONE utilities
CLOSED: [2020-10-23 Fri 10:09]
** DONE show results [3/3]
*** TODO ~test_fitHBsyn~
*** TODO ~extract_test_fit~ (Chi2)
*** DONE ~plot_test_fit~ (Chi2)
CLOSED: [2020-06-19 Fri 00:24]
*** DONE ~test_fitChi2syn~
CLOSED: [2020-06-19 Fri 00:21]
*** DONE ~test_profiles~
CLOSED: [2020-06-19 Fri 00:21]
** CNCL fits2h5
CLOSED: [2020-04-28 Tue 00:07]
- State "CNCL"       from "DONE"       [2020-10-22 Thu 13:57] \\
  merged to ~input_master~
** DONE asc2h5
CLOSED: [2020-04-27 Mon 23:35]
