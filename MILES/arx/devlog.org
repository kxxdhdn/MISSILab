#+TITLE: MILES development log
#+AUTHOR: D. HU
#+TODO: TODO(t) WAIT(w) | DONE(d)
#+TODO: | CNCL(c@/!)
#+TODO: REPORT(r!) BUG(b!) KNOWNCAUSE(k!) | FIXED(f!)
#+STARTUP: logdone

Version: v0.3.4 (20210526)
* Archive notes
- Stop updates at v0.3.4
- Later changelog see ~README.org~
* DONE tests (tests/) [12/12]
** DONE invert
CLOSED: [2021-04-14 Wed 10:42]
** DONE fitHB
CLOSED: [2021-01-13 Wed 18:55]
** DONE Bayes
CLOSED: [2021-01-13 Wed 18:55]
** DONE gibbs
CLOSED: [2020-09-28 Mon 15:06]
- [X] Vary 1 parameter a time to check the function ~specModel_gen~
- [X] Print parcurr(ipar) in the ~big_loop~ to check the parvec
- [X] Fix all but one parameter to check 
- [X] Redo above for the modified function with logarithmic param
- [X] plot the dist. for each param
** FIXED fitChi2
CLOSED: [2021-04-21 Wed 22:39]
- State "FIXED"      from "KNOWNCAUSE" [2021-04-21 Wed 22:39]
- Note taken on [2020-06-18 Thu 16:50] \\
  + [X] Very slow (probably due to the very small uncertainties, or largely varied S/N), should set timers;
    * Problem solved by move extCurve calculation from ~specModel~ to ~read_master~
  + [X] Fix the width of lines and weak bands;
  + [X] Should be able to block and retake at a certain pixel;
  + [X] Use fractional array writing (indN) in ~WRITE_HDF5~
  + [X] Discontinuity at 20 mcrons;
  + [X] Wavelength edge sensibility issue;
  + [X] ALL(mask(x,y,:)) or ANY(mask(x,y,:)) ? should allow lacking of isolated wvl (diff from the case of lacking the whole module); ANY
  + [X] Diagonal covar matrix used (for now): Chi2 cal too heavy to consider (see calib error); HB takes the correl (between wvl) into account intrinsically (?) \rarr in general, no need
  + [X] Added calib error
  + [X] Check if there is at least one wvl available in center \pm width/2 region for every line/band \rarr solved with param limits generated by ~initparam~
  + [X] Automatize param init ~initparam~
  + [X] Save all param (incl. fixed ones) in h5 file
- State "KNOWNCAUSE" from "TODO"       [2020-06-18 Thu 16:50]
** DONE read
CLOSED: [2020-10-23 Fri 10:56]
** FIXED profiles
CLOSED: [2020-04-25 Sat 19:27]
- Note taken on [2020-05-20 Wed 23:39] \\
  Corrected the integration in normalization tests. X grid should not be too wide or the the integration of undersampled profiles will not be 1
- State "FIXED"      from "DONE"       [2020-05-20 Wed 23:39]
** DONE compile
CLOSED: [2020-04-24 Fri 15:00]
** CNCL anaChi2
CLOSED: [2021-04-14 Wed 10:41]
- State "CNCL"       from "REPORT"     [2021-04-14 Wed 10:41]
- State "REPORT"     from "DONE"       [2020-12-21 Mon 14:50]
** CNCL fitHBsyn
CLOSED: [2020-10-02 Fri 10:20]
- State "CNCL"       from "FIXED"      [2021-01-14 Thu 15:35] \\
  See ~programs/simulate_MIR~
- State "FIXED"      from "REPORT"     [2020-10-02 Fri 10:17]
- Note taken on [2020-09-24 Thu 17:39] \\
  Bad fit, probably due to the problem of ~specModel_gen~ \rarr add ~test_gibbs~
- State "REPORT"     from "DONE"       [2020-09-24 Thu 17:39]
** CNCL fitChi2syn
CLOSED: [2020-12-10 Thu 10:51]
- State "CNCL"       from "FIXED"      [2021-01-14 Thu 15:33] \\
  See ~programs/simulate_MIR~
- State "FIXED"      from "REPORT"     [2020-12-09 Wed 17:51]
- Note taken on [2020-12-10 Thu 10:50] \\
  + Clarify chi2red value output (should be \sim 1)
  + Corrected vital error in external residual function (used in ~chi2min_LM~): should be weighted by dFnuOBS, which is uncertainty (fixed for a given wvl) instead of perturbation (random)!
  + Use ~read_master~ only for making Qabs (detached from input interface)
- State "REPORT"     from "DONE"       [2020-12-09 Wed 16:49]
- Note taken on [2020-10-05 Mon 17:53] \\
  After converting some param to logarithmic, the calculation takes a bit more time, but not obvious (according to Fred's test)
** CNCL modifBB
CLOSED: [2020-06-10 Wed 12:06]
- State "CNCL"       from "KNOWNCAUSE" [2020-06-10 Wed 12:06] \\
  Transfer to complete fit test of M83 (~test_fitChi2~)
- Note taken on [2020-05-11 Mon 14:32] \\
  Test chi2min with observation (M83), 3D FITS data imported via Python UI (fits2h5)
- State "KNOWNCAUSE" from "DONE"       [2020-05-11 Mon 14:32]
* DONE programs (src/) [100%]
:PROPERTIES:
:COOKIE_DATA: recursive
:END:
** DONE Simulation [100%]
*** INPUT files
**** ~data/galgen.fits~
**** ~data/galgen_unc.fits~
**** ~out/input_master.h5~
**** ~out/input_model.h5~
**** ~out/input_extra.h5~
*** OUTPUT files
**** ~out/observation_MIR.h5~
**** ~out/presimulation.h5~
**** ~out/simulation_MIR.h5~
**** ~out/fit_chi2.h5~
**** ~out/parlog_fit_bb.h5~
**** ~out/fit_bb.h5~
**** ~out/parlog_fit_hb.h5~
**** ~out/fit_hb.h5~
*** DONE ~pylib/input_presimulation.py~
CLOSED: [2021-02-10 Wed 00:45]
*** DONE ~src/presimulation.f90~
CLOSED: [2021-02-10 Wed 00:45]
*** DONE ~pylib/show_presimulation.py~
CLOSED: [2021-02-10 Wed 00:45]
*** DONE ~src/simulation.f90~
CLOSED: [2021-03-12 Fri 14:56]
- Note taken on [2021-04-07 Wed 14:06] \\
  Reparameterization
*** DONE ~pylib/show_simulation.py~
CLOSED: [2021-02-10 Wed 00:45]
*** DONE ~pylib/input_sim_chi2.py~
CLOSED: [2021-02-10 Wed 00:45]
*** DONE ~pylib/input_sim_bb.py~
CLOSED: [2021-03-31 Wed 15:29]
*** DONE ~pylib/input_sim_hb.py~
CLOSED: [2021-02-10 Wed 00:45]
*** DONE ~pylib/show_sim_corr.py~
CLOSED: [2021-02-10 Wed 00:45]
- Note taken on [2021-05-26 Wed 09:01] \\
  Corrected subplot error
- Note taken on [2021-04-07 Wed 14:07] \\
  Seperated figures
** DONE Post-processing [100%]
*** DONE ~analysis.f90~
CLOSED: [2021-04-14 Wed 10:42]
** DONE Hierarchical Bayesian (HISTOIRE): ~fit_hb.f90~ [100%]
- Note taken on [2021-04-21 Wed 23:20] \\
  + Replaced Cholesky invert by modified Sherman-Morrison formula in ~lnhyper_corr~
  + Corrected the error of the initialization of hyperparameter sampling
  + Change routine name from HIBARI to HISTOIRE
*** DONE add hyper param
CLOSED: [2021-01-13 Wed 18:55]
*** DONE test with M83 spectra
CLOSED: [2021-01-13 Wed 18:55]
*** DONE test HB with simulated spectra
CLOSED: [2021-02-10 Wed 00:35]
** DONE Belgium Bayesian (HISTOIRE): ~fit_hb.f90~ [100%]
*** DONE build structure according to ~fitSED_HB.f90~
CLOSED: [2020-09-03 Thu 17:30]
*** DONE test homogeneous prior dist. with synthetic spectrum
CLOSED: [2020-10-02 Fri 10:59]
*** DONE automatize ~read_master~ and ~initparam~
CLOSED: [2020-12-10 Thu 12:19]
*** DONE test with M83 spectra (init param via Chi2 results)
CLOSED: [2021-01-12 Tue 10:47]
*** DONE test with (more realistic) simulated spectra
CLOSED: [2021-02-10 Wed 00:34]
** DONE Chi2 (LE MIROIR): ~fit_chi2.f90~ [100%]
*** DONE test chi2min with synthetic spectrum
CLOSED: [2020-06-04 Thu 11:27]
*** DONE test chi2min with M83 (input 3D data)
CLOSED: [2020-06-18 Thu 16:50]
*** DONE Python UI for the inputs
CLOSED: [2020-12-10 Thu 12:15]
*** DONE add Monte Carlo estimation for Chi2 convergence (in func ~initparam~)
CLOSED: [2020-12-10 Thu 12:15]
*** CNCL seperate spectra from diff modules and add calib error param
CLOSED: [2021-05-12 Wed 10:52]
- State "CNCL"       from "TODO"       [2021-05-26 Wed 10:52] \\
  Added calib error as a nuisance parameter for HB fitting instead of doing it for Chi2
** CNCL Init [100%]
- State "CNCL"       from "DONE"       [2021-01-14 Thu 15:23]
*** DONE modeled spectrum
CLOSED: [2020-06-09 Tue 18:51]
*** DONE input spectrum
CLOSED: [2020-05-11 Mon 15:21]
- Note taken on [2020-10-22 Thu 17:02] \\
  merged to ~input_master.py~ ([obsolete] fits2h5.py)
* DONE auxil (aux/) [100%]
:PROPERTIES:
:COOKIE_DATA: recursive
:END:
** DONE ~core.f90~ [100%]
*** TYPE, PUBLIC
**** DONE ~par_type~
CLOSED: [2020-05-11 Mon 10:52]
**** DONE ~parinfo_type~
CLOSED: [2020-06-09 Tue 18:51]
**** DONE ~indpar_type~
CLOSED: [2020-09-23 Wed 10:58]
- Note taken on [2021-04-21 Wed 23:11] \\
  Reparameterization added variables ~refB~, ~refw~, ~grpQ~, ~ordQ~
  + lnMovd2 \rarr lnFcont
  + lnT \rarr lnT (lndT for ordQ>0)
  + lnIband \rarr lnRband (lnIband for refB)
  + lnIline \rarr lnRline
**** DONE ~Qabs_type~
CLOSED: [2020-05-11 Mon 11:47]
- Note taken on [2020-10-01 Thu 15:16] \\
  Replace coeffMBB by kappa; remove Qova
- Note taken on [2020-09-23 Wed 10:54] \\
  Added coeffMBB (simplify calculation)
*** SUBROUTINE
**** DONE ~initparam~ : Automatic initialization of model parameters
CLOSED: [2020-12-10 Thu 11:43]
- Note taken on [2021-04-12 Mon 00:20] \\
  Added limits of intensive parameters for newinit/chi2init
- Note taken on [2021-04-07 Wed 14:05] \\
  Reparameterization
- Note taken on [2021-03-31 Wed 15:36] \\
  Involved ~modiffBB~, ~gaussline~ and ~lorentzband~ in the auto limits to avoid PDF normalization difference due to the variable change (between \lambda and \nu);
  Force limited=.TRUE. for intensive parameters
- Note taken on [2021-01-27 Wed 15:16] \\
  Modified iniMC limits to more narrow ranges
**** DONE ~read_master~ : Read the input master file for the Chi2/HB run
CLOSED: [2020-10-23 Fri 10:13]
- Note taken on [2021-04-07 Wed 13:57] \\
  Reparameterization added inputs: refB, refw
- Note taken on [2021-03-31 Wed 15:40] \\
  Added resume option
- Note taken on [2021-02-10 Wed 00:33] \\
  Added extinction curve.
**** DONE ~set_indpar~ : Fill the ~INDPAR_TYPE~ structure, from a ~PARINFO_TYPE~ structure
CLOSED: [2020-09-23 Wed 10:58]
- Note taken on [2021-04-07 Wed 13:56] \\
  Reparameterization
**** DONE ~set_indref~ : see also ~set_indref~
CLOSED: [2021-04-07 Wed 13:55]
**** DONE ~make_Qabs~ : Read optical properties
CLOSED: [2020-05-11 Mon 11:47]
- State "DONE"       from "CNCL"       [2021-04-07 Wed 13:54]
- State "CNCL"       from "DONE"       [2020-09-23 Wed 10:57] \\
  Merged to ~read_master~
**** DONE ~check_SM~ : Prepare Sherman-Morrison approach
CLOSED: [2021-04-14 Wed 10:39]
**** CNCL ~make_par~ : Create the parameter structure (obsolete)
CLOSED: [2020-06-09 Tue 09:53]
- State "CNCL"       from "FIXED"      [2020-09-04 Fri 10:26] \\
  Update to ~read_master~
- State "FIXED"      from "KNOWNCAUSE" [2020-06-10 Wed 09:53]
- Note taken on [2020-06-09 Tue 09:52] \\
  Added Npar and parinfo as output option; par turns to be optional
- State "KNOWNCAUSE" from "DONE"       [2020-06-09 Tue 09:51]
**** CNCL ~chi2_INIT~ : Initialization of parameters for Chi2 method
CLOSED: [2020-05-25 Mon 18:11]
- State "CNCL"       from "DONE"       [2020-06-02 Tue 10:23] \\
  Removed. Parameters stored in a separate module/file
*** FUNCTION
**** Analytical functions of the individual features
***** DONE ~invert_SM~ : Sherman-Morrison approach to invert matrices
CLOSED: [2021-04-14 Wed 10:40]
***** DONE ~invert_mSM~ : Modified Sherman-Morrison approach to invert matrices
CLOSED: [2021-04-14 Wed 10:40]
***** FIXED ~modifBB~ : Dust contimuum (N BB)
CLOSED: [2020-12-10 Thu 11:55]
- Note taken on [2021-04-12 Mon 00:15] \\
  Updated input grids and added normalization option inorm
- State "FIXED"      from "KNOWNCAUSE" [2020-12-10 Thu 11:55]
- Note taken on [2020-12-10 Thu 11:54] \\
  Corresponding to BBQ in Fred's convention (\ne MBB with \beta)
- Note taken on [2020-09-30 Wed 18:49] \\
  lnMcont (mass of contimuum) should be ln(M/d^2) (lnMovd2) which is a mixing param in the sense of physics. The modified blackbody (MBB) here represents an average emission of the small grains of different size which are in stochastic state instead of thermal equilibrium. Indeed, if we suppose they each (in terms of size) are blackbody in a certain time scale (during which the temperature is constant T \prop h\nu), then the MBB we use here is the average effect in time. On the other hand, the mass Mcont as well as the distance d is not interesting unless we have indepandent observations to mesure them. (The same case for radiation field G_0 if we want to add stochastic heating model to include the time-dependant effect mentionned above.) For now we just leave ln(M/d^2) in our model as what Fred did in his Chi2 fitting code (on IDL).
- State "KNOWNCAUSE" from "DONE"       [2020-10-01 Thu 09:49]
- Note taken on [2020-09-23 Wed 10:53] \\
  Added generic interface for HB method
***** FIXED ~gaussLine~ : Atomic & molecular unresolved lines (Gauss profile)
CLOSED: [2020-05-20 Wed 23:36]
- Note taken on [2021-04-12 Mon 00:16] \\
  Updated input grids
- State "FIXED"      from "KNOWNCAUSE" [2020-05-20 Wed 23:36]
- Note taken on [2020-09-23 Wed 10:53] \\
  Added generic interface for HB method
- Note taken on [2020-05-12 Tue 10:51] \\
  ~gaussLine_w~ was added to make wave-in-nu-out possible (which is the idea here), while it rose a confusion when doing normalization test. 
  Finally, the merger of this option lead to a LOGICAL "w2nu", .TRUE. when input is wavelength, because the profiles will be used to fit the obs curves in function of nu whose intensities are in W/m2/Hz.  
  Idem. for lorentzBand & extCurve
- State "KNOWNCAUSE" from "DONE"       [2020-05-12 Tue 10:51]
***** FIXED ~lorentzBand~ : Resolved aromatic bands (Asymmetric Lorentz profile)
CLOSED: [2020-05-20 Wed 23:36]
- Note taken on [2021-04-12 Mon 00:17] \\
  Updated input grids and verified short/long side width
- State "FIXED"      from "KNOWNCAUSE" [2020-05-20 Wed 23:36]
- Note taken on [2020-09-23 Wed 10:53] \\
  Added generic interface for HB method
- State "KNOWNCAUSE" from "DONE"       [2020-05-12 Tue 10:57]
***** FIXED ~extCurve~
CLOSED: [2020-05-20 Wed 23:36]
- State "FIXED"      from "KNOWNCAUSE" [2020-05-20 Wed 23:36]
- State "KNOWNCAUSE" from "TODO"       [2020-05-12 Tue 10:57]
**** DONE ~degradeRes~ : Automatize the degradation of the spectral resolution
CLOSED: [2020-05-11 Mon 13:40]
**** DONE ~specModel~ : Total model function for Chi2/HB calling
CLOSED: [2020-12-08 Tue 16:05]
- Note taken on [2021-04-21 Wed 23:14] \\
  Reparameterization
- Note taken on [2021-04-07 Wed 13:52] \\
  Reparameterization
- Note taken on [2021-03-05 Fri 22:41] \\
  Simplification of ~specModel_gen~ (by Fred): run time 4 times faster
- Note taken on [2021-02-10 Wed 00:31] \\
  Modify inputs by adding extinct (speed problem solved). The extinction curve will be calculated in ~read_master~
- Note taken on [2021-01-11 Mon 17:40] \\
  Corrected 2 mistaken writing in ~specModel_gen~:
  1. some FnuLINE0 as FnuBAND0 by copy-paste;
  2. some FORALL conditions as (igrid=i,Nband) \rarr random values attributed to undefined grids
- Note taken on [2020-12-08 Tue 16:03] \\
  Timer added; 2D & 1D version derived from 3D code using interface.
- Note taken on [2020-10-01 Thu 15:17] \\
  Function & unit check: remove a extra pi in cont; lnMcont \rarr lnMovd2; lnTcont \rarr lnT; remove L_sun & pc in lnFstar unit. Basically the whole model is unit independent, that is, if the input FnuOBS is in MKS (W/m2/Hz/sr), than every compo is in MKS. Idem. if FnuOBS is in MJy/sr or Jy/pixel. Thus the unit conversions are done purely in Python IO interface. In the code, MKS is adopted (as an example) in order to show the dimensional analysis.
- Note taken on [2020-09-29 Tue 10:55] \\
  Logarithmic parameters (Mcont, Tcont, Iline, Iband, Av, Fstar)
- Note taken on [2020-09-22 Tue 16:00] \\
  1. Do NOT include ~CALL make_Qabs~ in the model, which will can repeat exponential times (e.g. reading procedure) in Bayesian/Mont-Carlo processes
  2. ~specModel_nD~
- Note taken on [2020-09-02 Wed 10:58] \\
  1. Adaptation for Bayesian method: add generic interface
  2. massBB \rarr Mcont, tempBB \rarr Tcont
- State "KNOWNCAUSE" from "FIXED"      [2020-09-02 Wed 10:58]
- State "FIXED"      from "REPORT"     [2020-06-17 Wed 01:56]
- Note taken on [2020-06-16 Tue 19:36] \\
  [via Fred]
  1. Do not read extcurve file everytime -> call it only once at the beginning
  2. Do not do interpolation in func modifBB -> interpolate Qabs once and for all (add optional input "waveall" in ~make_Qabs~)
- State "REPORT"     from "FIXED"      [2020-06-17 Wed 01:52]
- State "FIXED"      from "KNOWNCAUSE" [2020-06-16 Tue 15:22]
- Note taken on [2020-06-13 Sat 23:12] \\
  Create interface for 3D, 2D, etc. models
- State "KNOWNCAUSE" from "FIXED"      [2020-06-13 Sat 23:12]
- State "FIXED"      from "KNOWNCAUSE" [2020-06-09 Tue 10:26]
- Note taken on [2020-06-09 Tue 10:25] \\
  Added Npar and parinfo as output option
- State "KNOWNCAUSE" from "FIXED"      [2020-06-09 Tue 10:25]
- State "FIXED"      from "BUG"        [2020-06-03 Wed 17:20]
- Note taken on [2020-06-03 Wed 17:19] \\
  optional output should not be allocated out of IF (PRESENT) loop
- State "BUG"        from "FIXED"      [2020-06-03 Wed 17:19]
- State "FIXED"      from "KNOWNCAUSE" [2020-05-29 Fri 15:15]
- Note taken on [2020-05-26 Tue 16:41] \\
  Replace massStar by Fstar (total surface brightness of star), with BB normalized by Stefan-Boltzmann constant.
- State "KNOWNCAUSE" from "DONE"       [2020-05-26 Tue 16:41]
** DONE ~auxil.f90~
CLOSED: [2021-01-14 Thu 16:07]
*** PARAMETER, PUBLIC
~Ncont_max~, ~Nline_max~, ~Nband_max~, ~Npabs_max~, ~Nstar_max~, 
~Cband_sig~
*** TYPE, PUBLIC
**** TYPE(~instr_res~) :: res
**** TYPE(~line_type~) :: TABLine
**** TYPE(~band_type~) :: TABand
** DONE ~chi2.f90~
CLOSED: [2021-02-10 Wed 01:17]
Former ~fitMIR_chi2_external~ module
** DONE ~hb.f90~
CLOSED: [2021-02-10 Wed 01:17]
- Note taken on [2021-05-26 Wed 09:05] \\
  Correted error in ~lnhyper_sig~ covar matrix inversion opt.2 (non-Cholesky): ~1._DP/EXP(lnSgrid(:))~ instead of ~EXP(1._DP/lnSgrid(:))~
Former ~fitMIR_HB_external~ module
* DONE UI (pylib/) [100%]
:PROPERTIES:
:COOKIE_DATA: recursive
:END:
** INPUT file organization
*** ~out/set_input.h5~
*** ~dirIN/observations_MIR.h5~
*** ~dirIN/input_master.h5~
*** ~dirIN/input_model.h5~
*** ~dirIN/input_extra.h5~
** OUTPUT file organization
*** ~dirOUT/fit_chi2.h5~
*** ~dirOUT/parlog_fit_bb.h5~
*** ~dirOUT/fit_bb.h5~
*** ~dirOUT/parlog_fit_hb.h5~
*** ~dirOUT/fit_hb.h5~
** DONE inputs [7/7]
- Note taken on [2020-12-14 Mon 20:00] \\
  Added redshift
- Note taken on [2020-11-23 Mon 13:41] \\
  Added wvl auto detecting process to constrain band and line selection
*** DONE ~input_analysis.py~
CLOSED: [2021-06-08 Tue 12:00]
*** DONE ~input_hb.py~
CLOSED: [2021-04-14 Wed 10:43]
*** DONE ~input_bb.py~
CLOSED: [2021-04-21 Wed 15:59]
*** DONE ~input_chi2.py~
CLOSED: [2021-04-14 Wed 10:43]
** DONE visualisation [3/3]
*** DONE ~show_corr.py~
CLOSED: [2021-06-08 Tue 11:58]
*** DONE ~show_par.py~
CLOSED: [2021-05-26 Wed 12:09]
*** DONE ~show_fit.py~
CLOSED: [2021-05-26 Wed 08:50]
** DONE ~utilities.py~
*** DATA
**** ~res~
CLOSED: [2020-11-23 Mon 12:11]
**** ~TABLine~
CLOSED: [2020-11-23 Mon 12:11]
**** ~TABand~
CLOSED: [2020-11-23 Mon 12:11]
*** FUNC
**** ~partuning~
CLOSED: [2020-10-23 Fri 10:09]
- Note taken on [2021-04-07 Wed 14:12] \\
  Reparameterization
** DONE ~asc2h5.py~
CLOSED: [2020-04-27 Mon 23:35]
** CNCL ~fits2h5.py~
CLOSED: [2020-04-28 Tue 00:07]
- State "CNCL"       from "DONE"       [2020-10-22 Thu 13:57] \\
  merged to ~input_fitMIR.py~
